# é–‹ç™ºãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## ğŸ“š ç›®æ¬¡

1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](#é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)
3. [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](#ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„)
4. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)
5. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰)
6. [é‹ç”¨ãƒ»ç›£è¦–](#é‹ç”¨ç›£è¦–)
7. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è©³ç´°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è©³ç´°)
8. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
9. [ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥](#ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥)
10. [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒª](#ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚«ãƒãƒª)

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â”€â”€â”€â”€â–¶â”‚  LINE LIFF   â”‚â”€â”€â”€â”€â–¶â”‚   LINE API  â”‚
â”‚  (Browser)  â”‚â—€â”€â”€â”€â”€â”‚   Platform   â”‚â—€â”€â”€â”€â”€â”‚   Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â”‚                                          â”‚
       â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Express   â”‚â”€â”€â”€â”€â–¶â”‚   Database   â”‚     â”‚ Dify Chat   â”‚
â”‚   Server    â”‚â—€â”€â”€â”€â”€â”‚   (Future)   â”‚     â”‚   Service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â–²
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

1. **ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤**
   - LIFF ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (public/index.html)
   - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–UI
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

2. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤**
   - Express.js ã‚µãƒ¼ãƒãƒ¼
   - èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
   - ãƒ—ãƒ­ã‚­ã‚·æ©Ÿèƒ½

3. **ãƒ‡ãƒ¼ã‚¿å±¤**
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
   - å°†æ¥çš„ãªDBé€£æº

4. **å¤–éƒ¨é€£æºå±¤**
   - LINE API
   - Dify Chat Service

## ğŸ’» é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. **å¿…è¦ãªãƒ„ãƒ¼ãƒ«**
   ```bash
   # Node.js (14ä»¥ä¸Š)
   node --version

   # npm ã¾ãŸã¯ yarn
   npm --version

   # Git
   git --version

   # ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆæ¨å¥¨: VS Codeï¼‰
   ```

2. **VS Code æ¨å¥¨æ‹¡å¼µæ©Ÿèƒ½**
   - ESLint
   - Prettier
   - GitLens
   - Thunder Client (API ãƒ†ã‚¹ãƒˆç”¨)
   - Mermaid Preview

3. **é–‹ç™ºç’°å¢ƒã®è¨­å®š**
   ```bash
   # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
   git clone <repository-url>
   cd claude-liff-auth

   # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   npm install

   # é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
   cp .env.example .env.development
   # .env.development ã‚’ç·¨é›†

   # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
   npm run dev
   ```

### ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥

```
main
 â”œâ”€â”€ develop
 â”‚    â”œâ”€â”€ feature/add-payment-check
 â”‚    â”œâ”€â”€ feature/improve-ui
 â”‚    â””â”€â”€ feature/add-logging
 â”œâ”€â”€ staging
 â””â”€â”€ hotfix/critical-bug
```

- **main**: æœ¬ç•ªç’°å¢ƒ
- **develop**: é–‹ç™ºç’°å¢ƒ
- **staging**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
- **feature/***: æ©Ÿèƒ½é–‹ç™º
- **hotfix/***: ç·Šæ€¥ä¿®æ­£

### ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type:**
- feat: æ–°æ©Ÿèƒ½
- fix: ãƒã‚°ä¿®æ­£
- docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- style: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- refactor: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- test: ãƒ†ã‚¹ãƒˆ
- chore: ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ„ãƒ¼ãƒ«

**ä¾‹:**
```
feat(auth): Add rate limiting to authentication endpoint

- Implement express-rate-limit middleware
- Set limit to 100 requests per 15 minutes
- Add custom error messages

Closes #123
```

## ğŸ“ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### JavaScript/Node.js

1. **åŸºæœ¬ãƒ«ãƒ¼ãƒ«**
   ```javascript
   // Good
   const CONFIG = {
     API_TIMEOUT: 10000,
     MAX_RETRIES: 3
   };

   // Bad
   var config = {
     timeout: 10000,
     retries: 3
   }
   ```

2. **éåŒæœŸå‡¦ç†**
   ```javascript
   // Good - async/await ã‚’ä½¿ç”¨
   async function fetchData() {
     try {
       const result = await apiCall();
       return result;
     } catch (error) {
       logger.error('API call failed:', error);
       throw error;
     }
   }

   // Bad - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°ç„
   function fetchData(callback) {
     apiCall((err, result) => {
       if (err) callback(err);
       else callback(null, result);
     });
   }
   ```

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   ```javascript
   // Good - è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±
   class AuthenticationError extends Error {
     constructor(message, statusCode = 401) {
       super(message);
       this.name = 'AuthenticationError';
       this.statusCode = statusCode;
     }
   }

   // Bad - æ±ç”¨çš„ã™ãã‚‹ã‚¨ãƒ©ãƒ¼
   throw new Error('Error occurred');
   ```

### HTML/CSS

1. **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML**
   ```html
   <!-- Good -->
   <nav class="main-navigation">
     <ul>
       <li><a href="#home">Home</a></li>
     </ul>
   </nav>

   <!-- Bad -->
   <div class="nav">
     <div class="list">
       <div><a href="#home">Home</a></div>
     </div>
   </div>
   ```

2. **CSSå‘½åè¦å‰‡ (BEM)**
   ```css
   /* Good */
   .chat-container {}
   .chat-container__header {}
   .chat-container__body {}
   .chat-container--active {}

   /* Bad */
   .chat {}
   .chat-hdr {}
   .active-chat {}
   ```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 1. èªè¨¼ãƒ»èªå¯

```javascript
// JWTãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªç”Ÿæˆ
function generateSecureToken(payload) {
  const token = jwt.sign(
    {
      ...payload,
      jti: crypto.randomBytes(16).toString('hex'), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
      iat: Math.floor(Date.now() / 1000),
      iss: 'claude-liff-auth'
    },
    process.env.JWT_SECRET,
    {
      algorithm: 'HS256',
      expiresIn: '5m' // çŸ­ã„æœ‰åŠ¹æœŸé™
    }
  );
  return token;
}
```

### 2. å…¥åŠ›æ¤œè¨¼

```javascript
// å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
const validator = require('validator');

function validateInput(req, res, next) {
  const { idToken } = req.body;

  if (!idToken || typeof idToken !== 'string') {
    return res.status(400).json({
      error: 'Invalid input',
      message: 'ID token is required and must be a string'
    });
  }

  // XSSå¯¾ç­–
  req.body.idToken = validator.escape(idToken);
  next();
}
```

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

```javascript
// Helmetè¨­å®šã®è©³ç´°
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'", "https://static.line-scdn.net"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.line.me"],
      frameSrc: ["'self'", process.env.DIFY_CHAT_URL]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

### 4. ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

```bash
# æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšå¼·åŠ›ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨
JWT_SECRET=$(openssl rand -base64 32)

# ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–
# AWS Systems Manager Parameter Store
# Azure Key Vault
# Google Secret Manager
```

### 5. ä¾å­˜é–¢ä¿‚ã®ç®¡ç†

```bash
# è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
npm audit

# è‡ªå‹•ä¿®æ­£
npm audit fix

# ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
npm update

# æœ¬ç•ªç’°å¢ƒã§ã¯--productionãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨
npm ci --production
```

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰

### 1. æœ¬ç•ªç’°å¢ƒã®æº–å‚™

```bash
# æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰
NODE_ENV=production npm ci --production

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
node -e "console.log(Object.keys(process.env).filter(k => k.startsWith('LINE_') || k.startsWith('JWT_')))"

# ãƒãƒ¼ãƒˆç¢ºèª
sudo lsof -i :3000
```

### 2. PM2ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'liff-chat-service',
    script: './index.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: 'logs/err.log',
    out_file: 'logs/out.log',
    log_file: 'logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    watch: false,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
```

### 3. Nginxè¨­å®šä¾‹

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 4. Docker ãƒ‡ãƒ—ãƒ­ã‚¤

```dockerfile
# Dockerfile
FROM node:18-alpine

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
RUN apk update && apk upgrade

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --production && npm cache clean --force

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
COPY --chown=nodejs:nodejs . .

USER nodejs

EXPOSE 3000

CMD ["node", "index.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
    env_file:
      - .env.production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

## ğŸ“Š é‹ç”¨ãƒ»ç›£è¦–

### 1. ãƒ­ã‚®ãƒ³ã‚°æˆ¦ç•¥

```javascript
// ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'liff-chat-service' },
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

// æ§‹é€ åŒ–ãƒ­ã‚°
logger.info('User authenticated', {
  userId: decoded.userId,
  timestamp: new Date().toISOString(),
  ip: req.ip
});
```

### 2. ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†

```javascript
// Prometheus ãƒ¡ãƒˆãƒªã‚¯ã‚¹
const promClient = require('prom-client');
const collectDefaultMetrics = promClient.collectDefaultMetrics;

collectDefaultMetrics();

const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status']
});

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use((req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    httpRequestDuration
      .labels(req.method, req.route?.path || 'unknown', res.statusCode)
      .observe(duration / 1000);
  });
  next();
});
```

### 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```javascript
// è©³ç´°ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
app.get('/health/detailed', async (req, res) => {
  const checks = {
    uptime: process.uptime(),
    timestamp: new Date().toISOString(),
    memory: process.memoryUsage(),
    environment: process.env.NODE_ENV,
    checks: {}
  };

  // LINE APIæ¥ç¶šãƒã‚§ãƒƒã‚¯
  try {
    await axios.get('https://api.line.me/v2/bot/info', {
      headers: { 'Authorization': `Bearer ${process.env.LINE_CHANNEL_SECRET}` },
      timeout: 5000
    });
    checks.checks.lineApi = 'ok';
  } catch (error) {
    checks.checks.lineApi = 'error';
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒã‚§ãƒƒã‚¯ï¼ˆå°†æ¥å®Ÿè£…æ™‚ï¼‰
  // checks.checks.database = await checkDatabase();

  const allHealthy = Object.values(checks.checks).every(status => status === 'ok');
  res.status(allHealthy ? 200 : 503).json(checks);
});
```

### 4. ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

```yaml
# prometheus-alerts.yml
groups:
  - name: liff-chat-alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% for 5 minutes"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time"
          description: "95th percentile response time is above 1 second"
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è©³ç´°

### ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºç­–

#### 1. LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
LIFF init failed: Invalid LIFF ID
```

**åŸå› ã¨è§£æ±ºç­–:**
```javascript
// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¿½åŠ 
liff.init({
  liffId: CONFIG.liffId,
  withLoginOnExternalBrowser: true
}).catch(error => {
  console.error('LIFF init error details:', {
    error: error.message,
    liffId: CONFIG.liffId,
    url: window.location.href,
    userAgent: navigator.userAgent
  });
});
```

**ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
- [ ] LIFF IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URLãŒæ­£ã—ã„ã‹
- [ ] HTTPSã§å‹•ä½œã—ã¦ã„ã‚‹ã‹ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- [ ] ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒLINEãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹

#### 2. JWTæ¤œè¨¼ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
JsonWebTokenError: invalid signature
```

**ãƒ‡ãƒãƒƒã‚°æ‰‹é †:**
```bash
# JWTã®å†…å®¹ã‚’ç¢ºèª
echo "YOUR_JWT_TOKEN" | cut -d. -f2 | base64 -d | jq

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
node -e "console.log('JWT_SECRET length:', process.env.JWT_SECRET?.length)"
```

#### 3. CORS ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶:**
```
Access to fetch at 'http://localhost:3000/auth' from origin 'https://liff.line.me' has been blocked by CORS policy
```

**è§£æ±ºç­–:**
```javascript
// CORSè¨­å®šã®ãƒ‡ãƒãƒƒã‚°
app.use((req, res, next) => {
  console.log('CORS Debug:', {
    origin: req.headers.origin,
    method: req.method,
    path: req.path
  });
  next();
});
```

#### 4. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

**æ¤œå‡ºæ–¹æ³•:**
```javascript
// ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–
setInterval(() => {
  const usage = process.memoryUsage();
  console.log('Memory Usage:', {
    rss: `${Math.round(usage.rss / 1024 / 1024)}MB`,
    heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)}MB`,
    heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)}MB`,
    external: `${Math.round(usage.external / 1024 / 1024)}MB`
  });
}, 60000); // 1åˆ†ã”ã¨
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

```javascript
// Redis ã‚’ä½¿ç”¨ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
const redis = require('redis');
const client = redis.createClient();

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
async function getCachedUserInfo(userId) {
  const cacheKey = `user:${userId}`;
  const cached = await client.get(cacheKey);
  
  if (cached) {
    return JSON.parse(cached);
  }
  
  const userInfo = await fetchUserInfoFromDB(userId);
  await client.setex(cacheKey, 300, JSON.stringify(userInfo)); // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  return userInfo;
}
```

### 2. åœ§ç¸®ã®æœ‰åŠ¹åŒ–

```javascript
const compression = require('compression');

app.use(compression({
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  },
  level: 6 // åœ§ç¸®ãƒ¬ãƒ™ãƒ«ï¼ˆ1-9ï¼‰
}));
```

### 3. æ¥ç¶šãƒ—ãƒ¼ãƒªãƒ³ã‚°

```javascript
// HTTP Keep-Alive ã®è¨­å®š
const https = require('https');
const keepAliveAgent = new https.Agent({
  keepAlive: true,
  keepAliveMsecs: 3000,
  maxSockets: 50,
  maxFreeSockets: 10,
  timeout: 60000
});

// axiosã§ã®ä½¿ç”¨
const axiosInstance = axios.create({
  httpsAgent: keepAliveAgent,
  timeout: 10000
});
```

## ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### 1. æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

```javascript
// cluster ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
const cluster = require('cluster');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  console.log(`Master ${process.pid} is running`);

  // ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®èµ·å‹•
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }

  cluster.on('exit', (worker, code, signal) => {
    console.log(`Worker ${worker.process.pid} died`);
    cluster.fork(); // è‡ªå‹•å†èµ·å‹•
  });
} else {
  // ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹
  require('./index.js');
  console.log(`Worker ${process.pid} started`);
}
```

### 2. ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°

```nginx
# Nginx upstream è¨­å®š
upstream app_servers {
    least_conn;
    server 127.0.0.1:3001 weight=3;
    server 127.0.0.1:3002 weight=2;
    server 127.0.0.1:3003 weight=1;
    keepalive 32;
}
```

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

```javascript
// æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®š
const { Pool } = require('pg');
const pool = new Pool({
  max: 20, // æœ€å¤§æ¥ç¶šæ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
  statement_timeout: 5000
});

// ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
const getUserPaymentStatus = async (userId) => {
  const query = `
    SELECT 
      u.id, 
      u.is_paid,
      u.subscription_expires_at
    FROM users u
    WHERE u.line_user_id = $1
    AND u.is_active = true
    FOR UPDATE SKIP LOCKED
  `;
  const result = await pool.query(query, [userId]);
  return result.rows[0];
};
```

## ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒª

### 1. ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```bash
#!/bin/bash
# backup.sh

# ç’°å¢ƒå¤‰æ•°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆPostgreSQLä¾‹ï¼‰
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME > backup_$(date +%Y%m%d_%H%M%S).sql

# S3ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 cp backup_*.sql s3://your-backup-bucket/database/
```

### 2. ç½å®³å¾©æ—§è¨ˆç”»

```yaml
# disaster-recovery-plan.yml
recovery_objectives:
  rto: "4 hours"  # Recovery Time Objective
  rpo: "1 hour"   # Recovery Point Objective

backup_schedule:
  database:
    frequency: "hourly"
    retention: "7 days"
  
  application:
    frequency: "daily"
    retention: "30 days"

failover_procedures:
  - step: "Detect failure"
    sla: "5 minutes"
  
  - step: "Notify team"
    sla: "10 minutes"
  
  - step: "Switch to backup"
    sla: "30 minutes"
  
  - step: "Verify services"
    sla: "1 hour"
```

### 3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
#!/bin/bash
# rollback.sh

# å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
PREVIOUS_VERSION=$(git tag | sort -V | tail -2 | head -1)

echo "Rolling back to version: $PREVIOUS_VERSION"

# Git ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
git checkout $PREVIOUS_VERSION

# ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm ci --production

# ã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•
pm2 restart liff-chat-service

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl -f http://localhost:3000/health || exit 1

echo "Rollback completed successfully"
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»é€£çµ¡å…ˆ

### é–‹ç™ºãƒãƒ¼ãƒ 
- **ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒªãƒ¼ãƒ‰**: tech-lead@example.com
- **DevOps**: devops@example.com
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: security@example.com

### ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †
1. **Level 1**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ç¢ºèª
2. **Level 2**: é–‹ç™ºãƒãƒ¼ãƒ ã¸é€£çµ¡
3. **Level 3**: ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒªãƒ¼ãƒ‰ã¸ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
4. **Level 4**: ç·Šæ€¥å¯¾å¿œãƒãƒ¼ãƒ æ‹›é›†

### æœ‰ç”¨ãªãƒªã‚½ãƒ¼ã‚¹
- [ç¤¾å†…Wiki](https://wiki.example.com/liff-chat-service)
- [ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://monitoring.example.com)
- [ãƒ­ã‚°åˆ†æ](https://logs.example.com)
- [ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†](https://incidents.example.com)